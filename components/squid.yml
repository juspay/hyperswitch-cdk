name: InstallSquid
description: This document installs Squid and Wazuh on top of Amazon Linux 2023
schemaVersion: 1.0

phases:
    - name: build
      steps:
        - name: InstallSquid
          action: ExecuteBash
          inputs:
            commands:
                - echo "=== Installing Wazuh Agent on Amazon Linux 2023 ==="
                - sudo rpm --import https://packages.wazuh.com/key/GPG-KEY-WAZUH
                - echo -e "[wazuh]\ngpgcheck=1\ngpgkey=https://packages.wazuh.com/key/GPG-KEY-WAZUH\nenabled=1\nname=EL-\$releasever - Wazuh\nbaseurl=https://packages.wazuh.com/4.x/yum/\nprotect=1" | sudo tee /etc/yum.repos.d/wazuh.repo > /dev/null
                - sudo dnf install -y wazuh-agent
                - sudo sed -i 's|<address>MANAGER_IP</address>|<address>10.0.0.2</address>|' /var/ossec/etc/ossec.conf
                - sudo systemctl daemon-reload
                - sudo systemctl enable wazuh-agent
                - sudo systemctl start wazuh-agent || echo "Wazuh agent failed to start, continuing..."
                - sudo sed -i 's/^enabled=1/enabled=0/' /etc/yum.repos.d/wazuh.repo
                - sudo dnf update -y
                
                - echo "=== Installing Squid Proxy ==="
                - sudo dnf install -y squid
                - sudo systemctl enable squid
                - sudo systemctl start squid
